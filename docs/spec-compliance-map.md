# Spec Compliance Map

This document maps packet MUST/SHALL requirements to implemented modules and deterministic verification for Phase 2 hard guarantees.

## Requirements Map (MUST/SHALL)

| Requirement | Spec Reference (file#anchor) | Implementation (path) | Verification (gate/test/validator) |
|---|---|---|---|
| Offline-by-default; explicit gating + allowlist + proof artifacts; mechanical default-deny. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#0-non-negotiable-invariants-mechanisms`, `#1-offline-enforcement-mechanism-not-just-ui` | `/Users/d/Projects/AIGCCore/core/src/policy/egress.rs`, `/Users/d/Projects/AIGCCore/core/src/policy/allowlist.rs`, `/Users/d/Projects/AIGCCore/core/src/policy/network_snapshot.rs` | Gates `OFFLINE_ENFORCEMENT.MODE_PROOF_V1`, `OFFLINE_ENFORCEMENT.ALLOWLIST_MATCH_V1`; validator `CHK.NETWORK.SNAPSHOT_PRESENT`; tests in `/Users/d/Projects/AIGCCore/core/tests/egress_enforcement.rs` |
| All Core HTTP(S) routes through egress enforcement; UI does not directly egress; remote origin loading disabled. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#1-1-runtime-egress-model` | `/Users/d/Projects/AIGCCore/core/src/policy/egress.rs`, `/Users/d/Projects/AIGCCore/src-tauri/src/main.rs`, `/Users/d/Projects/AIGCCore/src-tauri/tauri.conf.json`, `/Users/d/Projects/AIGCCore/tools/gates/check-egress-enforcement.mjs` | `pnpm gate:all` includes static gate `EGRESS_ENFORCEMENT` and runtime offline gates |
| Adapters must be loopback-only (`127.0.0.1`) and align with Annex B v1 contracts. | `Annex_B_Adapter_Interface_v1_Spec.md#b-1-transport`, `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#1-1-runtime-egress-model` | `/Users/d/Projects/AIGCCore/core/src/adapters/interface.rs`, `/Users/d/Projects/AIGCCore/core/src/adapters/loopback.rs`, `/Users/d/Projects/AIGCCore/core/src/adapters/runtime.rs` | tests `/Users/d/Projects/AIGCCore/core/tests/adapter_interface.rs`, `/Users/d/Projects/AIGCCore/core/tests/adapter_runtime.rs`; network snapshot validation gate |
| Audit events are canonicalized and hash-chained with locked event envelope + canonicalization ID. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#2-audit-log-hash-chain-canonicalization-tamper-evident-baseline`, `Addendum_B_Audit_Event_Taxonomy_v2.md#1-audit-event-envelope-normative` | `/Users/d/Projects/AIGCCore/core/src/audit/event.rs`, `/Users/d/Projects/AIGCCore/core/src/audit/log.rs`, `/Users/d/Projects/AIGCCore/core/src/determinism/json_canonical.rs` | Gate `AUDIT_HASH_CHAIN.VERIFY_V1`; validator `CHK.AUDIT.REQUIRED_KEYS_AND_CHAIN`; tests `/Users/d/Projects/AIGCCore/core/tests/determinism_and_audit.rs` |
| Evidence Bundle v1 required layout and required files. | `Annex_A_Evidence_Bundle_v1_Spec.md#a-3-directory-layout-inside-the-zip`, `#a-4-required-files-and-why` | `/Users/d/Projects/AIGCCore/core/src/evidence_bundle/builder.rs`, `/Users/d/Projects/AIGCCore/core/src/evidence_bundle/schemas.rs` | Gate `BUNDLE_FORMAT.REQUIRED_FILES_V1`; validator `CHK.BUNDLE.REQUIRED_FILES` |
| Deliverables and attachments paths are locked; `templates_used.json` is required under attachments. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#4-evidence-bundle-v1-path-lock-deliverables-vs-attachments` | `/Users/d/Projects/AIGCCore/core/src/evidence_bundle/builder.rs`, `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` | validator `CHK.EXPORTS.ATTACHMENTS_LAYOUT`; gate `BUNDLE_FORMAT.REQUIRED_FILES_V1` |
| Deterministic ZIP export rules: sorted paths, fixed metadata, reproducible bytes when determinism enabled. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#3-1-zip-packaging-determinism`, `Addendum_A_Determinism_Matrix_v2.md#4-zip-packaging-determinism-normative` | `/Users/d/Projects/AIGCCore/core/src/determinism/zip.rs`, `/Users/d/Projects/AIGCCore/core/src/evidence_bundle/builder.rs` | gate `DETERMINISM.ZIP_PACKAGING_V1`; validator `CHK.DETERMINISM.ZIP_RULES`; test `/Users/d/Projects/AIGCCore/core/tests/determinism_and_audit.rs` |
| Deterministic `run_id` and locked epoch behavior in determinism mode. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#3-2-stable-ids-no-now-drift` | `/Users/d/Projects/AIGCCore/core/src/determinism/run_id.rs` | test `/Users/d/Projects/AIGCCore/core/tests/determinism_and_audit.rs` |
| Input export profile (`HASH_ONLY` vs `INCLUDE_INPUT_BYTES`) is explicit and validator behavior is profile-aware. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#4-1-input-export-profile-locked` | `/Users/d/Projects/AIGCCore/core/src/evidence_bundle/builder.rs`, `/Users/d/Projects/AIGCCore/core/src/validator/mod.rs` | validator `CHK.ARTIFACT_HASHES.VERIFY`; self-audit gate run in `pnpm gate:all` |
| `artifact_hashes.csv` schema + deterministic ordering by `artifact_id`, then `bundle_rel_path`. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#4-2-artifact-hashes-csv-schema-ordering-locked` | `/Users/d/Projects/AIGCCore/core/src/evidence_bundle/artifact_hashes.rs` | validator `CHK.ARTIFACT_HASHES.VERIFY`; test `/Users/d/Projects/AIGCCore/core/tests/artifact_hashes_csv.rs` |
| Strict citation enforcement (locator schema + marker coverage). | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#5-citation-locator-schema-locked-locator-schema-v1` | `/Users/d/Projects/AIGCCore/core/src/validator/mod.rs`, `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` | gate `CITATIONS.STRICT_ENFORCED_V1`; validator `CHK.CITATIONS.STRICT` |
| Redaction policy gate with required coverage for cited restricted/tagged artifacts. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#6-redaction-schema-export-gate-locked-redaction-schema-v1` | `/Users/d/Projects/AIGCCore/core/src/validator/mod.rs`, `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` | gate `REDACTION.REQUIRED_APPLIED_V1`; validator `CHK.REDACTION.POLICY_GATE` |
| Model identity pinning minimums by policy; strict/balanced block insufficient pinning. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#7-model-identity-pinning-rules-locked-aligned-to-annex-b-v1` | `/Users/d/Projects/AIGCCore/core/src/adapters/pinning.rs`, `/Users/d/Projects/AIGCCore/core/src/policy/export_gate.rs`, `/Users/d/Projects/AIGCCore/core/src/validator/mod.rs` | gate `MODEL_PINNING.MIN_LEVEL_V1`; validator `CHK.MODEL.PINNING_LEVEL`; tests `/Users/d/Projects/AIGCCore/core/tests/export_gate.rs` |
| Eval gate registry v3 is executed with stable IDs and recorded in `eval_report.json`. | `Eval_Gate_Registry_v3.md#registry-json-authoritative` | `/Users/d/Projects/AIGCCore/core/src/eval/registry.rs`, `/Users/d/Projects/AIGCCore/core/src/eval/registry_v3.json`, `/Users/d/Projects/AIGCCore/core/src/eval/runner.rs`, `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` | `pnpm gate:all`; validator `CHK.EVAL.REPORT_AND_GATES` |
| Bundle validator enforces Checklist v3 semantics. | `Bundle_Validator_Checklist_v3.md#checklist-json-authoritative` | `/Users/d/Projects/AIGCCore/core/src/validator/checklist_v3.json`, `/Users/d/Projects/AIGCCore/core/src/validator/mod.rs`, `/Users/d/Projects/AIGCCore/tools/bundle_validator/src/main.rs` | validator outputs `CHK.*`; integrated in gate runner and export flow |
| Vault encryption at rest and key lifecycle events are enforced and auditable. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#10-vault-crypto-v1-locked`, `Addendum_B_Audit_Event_Taxonomy_v2.md#3-7-vault-crypto-deletion-required-capabilities` | `/Users/d/Projects/AIGCCore/core/src/storage/crypto.rs`, `/Users/d/Projects/AIGCCore/core/src/storage/key_management.rs`, `/Users/d/Projects/AIGCCore/core/src/storage/vault.rs`, `/Users/d/Projects/AIGCCore/core/src/run/lifecycle.rs` | gate `VAULT_CRYPTO.ENCRYPTION_AT_REST_V1`; tests `/Users/d/Projects/AIGCCore/core/tests/crypto_roundtrip.rs`, `/Users/d/Projects/AIGCCore/core/tests/vault_storage.rs` |
| Non-bypassable export pipeline order and block/fail semantics are enforced in RunManager. | `Implementation_Plan_Phases_2_to_7_v2.7-rev6.md#3-3-non-bypassable-export-pipeline-locked-order` | `/Users/d/Projects/AIGCCore/core/src/run/manager.rs` | test `/Users/d/Projects/AIGCCore/core/tests/run_manager_state.rs`; gate run path in `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` |

## STOP Items

No STOP items.

## Resolved Conflicts (Packet Precedence)

- `Bundle_Validator_Checklist_v3.md` includes an `allowed_registry_versions` field listing `v1|v2`, while `Eval_Gate_Registry_v3.md` defines the active locked registry as `gates_registry_v3`. Per packet precedence, Core emits and accepts `gates_registry_v3` and remains backward-compatible with `v1|v2`.
- `Eval_Gate_Registry_v3.md` includes a textual reference to lock-3 in the redaction gate description, while lock-4 is the active lock document. Enforcement behavior follows lock-4 semantics.

## Scope Note

This map now covers Phase 2 hard guarantees and Phase 3 EvidenceOS pack requirements, and references only implemented modules.

## Phase 3 â€” EvidenceOS Pack (MUST/SHALL Map)

| Requirement | Spec Reference (file#anchor) | Implementation (path) | Verification (gate/test/validator) |
|---|---|---|---|
| EvidenceOS pack must build on top of Core contracts without bypassing export pipeline. | `Implementation_Plan_Phases_2_to_7_v2.7-rev6.md#4-phase-3-evidenceos-pack`, `#3-3-non-bypassable-export-pipeline-locked-order` | `/Users/d/Projects/AIGCCore/core/src/run/manager.rs`, `/Users/d/Projects/AIGCCore/core/src/evidenceos/mod.rs`, `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` | integration tests under `/Users/d/Projects/AIGCCore/core/tests/evidenceos_pack.rs`; `pnpm gate:all` Phase 3 pack run |
| Evidence item model must include artifact refs, tags, and control-family labels. | `Implementation_Plan_Phases_2_to_7_v2.7-rev6.md#4-phase-3-evidenceos-pack`, `Phase_1_Governance_Blueprint_Outline.md#1-5-cross-framework-crosswalk-capability--evidence` | `/Users/d/Projects/AIGCCore/core/src/evidenceos/model.rs` | unit tests in `/Users/d/Projects/AIGCCore/core/tests/evidenceos_model.rs` |
| Control library must be capability-based and reviewable in UI workflow. | `Implementation_Plan_Phases_2_to_7_v2.7-rev6.md#4-phase-3-evidenceos-pack`, `Phase_1_Governance_Blueprint_Outline.md#1-5-cross-framework-crosswalk-capability--evidence` | `/Users/d/Projects/AIGCCore/core/src/evidenceos/control_library.rs`, `/Users/d/Projects/AIGCCore/src-tauri/src/main.rs`, `/Users/d/Projects/AIGCCore/src/ui/App.tsx` | UI/unit tests in `/Users/d/Projects/AIGCCore/src/smoke.test.ts`; core tests in `/Users/d/Projects/AIGCCore/core/tests/evidenceos_model.rs` |
| Evidence mapping workflow must produce reviewer-facing status and missing-evidence output. | `Implementation_Plan_Phases_2_to_7_v2.7-rev6.md#4-phase-3-evidenceos-pack` | `/Users/d/Projects/AIGCCore/core/src/evidenceos/workflow.rs`, `/Users/d/Projects/AIGCCore/core/src/evidenceos/render.rs` | `/Users/d/Projects/AIGCCore/core/tests/evidenceos_pack.rs`; Phase 3 gate checks in `pnpm gate:all` |
| Narrative generation must enforce strict citation policy: no citation, no claim. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#5-citation-locator-schema-locked-locator-schema-v1`, `Implementation_Plan_Phases_2_to_7_v2.7-rev6.md#4-phase-3-evidenceos-pack`, `Phase_0_AI_Governance_Bible_Blueprint.md#p0-04-citation-grounded-outputs-for-high-stakes-use` | `/Users/d/Projects/AIGCCore/core/src/evidenceos/narrative.rs`, `/Users/d/Projects/AIGCCore/core/src/validator/mod.rs` | gate `CITATIONS.STRICT_ENFORCED_V1`; EvidenceOS unit tests in `/Users/d/Projects/AIGCCore/core/tests/evidenceos_model.rs` |
| Phase 3 outputs must include Evidence Index and Missing Evidence Checklist as export artifacts. | `Implementation_Plan_Phases_2_to_7_v2.7-rev6.md#4-phase-3-evidenceos-pack` | `/Users/d/Projects/AIGCCore/core/src/evidenceos/render.rs`, `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` | gate `EVIDENCEOS.OUTPUTS_PRESENT_V1`; `/Users/d/Projects/AIGCCore/core/tests/evidenceos_pack.rs` |
| EvidenceOS exports must remain compliant with Evidence Bundle v1 required structure and validator checklist. | `Annex_A_Evidence_Bundle_v1_Spec.md#a-3-directory-layout-inside-the-zip`, `Bundle_Validator_Checklist_v3.md#checklist-json-authoritative` | `/Users/d/Projects/AIGCCore/core/src/evidence_bundle/builder.rs`, `/Users/d/Projects/AIGCCore/core/src/validator/mod.rs`, `/Users/d/Projects/AIGCCore/tools/bundle_validator/src/main.rs` | validator `CHK.*`; `pnpm gate:all` |
| Offline-by-default guarantees and loopback adapter constraints must remain unchanged for Phase 3 flows. | `Phase_2_5_Lock_Addendum_v2.5-lock-4.md#0-non-negotiable-invariants-mechanisms`, `Annex_B_Adapter_Interface_v1_Spec.md#b-1-transport` | `/Users/d/Projects/AIGCCore/core/src/policy/egress.rs`, `/Users/d/Projects/AIGCCore/core/src/adapters/loopback.rs`, `/Users/d/Projects/AIGCCore/src-tauri/src/main.rs` | existing gates `OFFLINE_ENFORCEMENT.*`; static egress gate in `pnpm gate:all` |
| Deterministic Phase 3 artifacts must be stable across identical runs when determinism is enabled. | `Addendum_A_Determinism_Matrix_v2.md#3-artifact-determinism-matrix-normative`, `#4-zip-packaging-determinism-normative` | `/Users/d/Projects/AIGCCore/core/src/evidenceos/render.rs`, `/Users/d/Projects/AIGCCore/tools/gate_runner/src/main.rs` | deterministic dual-run check in `pnpm gate:all`; `/Users/d/Projects/AIGCCore/core/tests/evidenceos_pack.rs` |
